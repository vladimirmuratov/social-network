import React, {useEffect, useState} from 'react'
import {Redirect} from "react-router";
import {getAllDialogsApi} from "api";
import {Link} from "react-router-dom";
import userImgDefault from "images/user.png"
import Loader from 'components/loader'

const Dialogs = () => {
    if (!localStorage.getItem("userIsLogged")) {
        return <Redirect to="/login"/>
    }

    const [dialogs, setDialogs] = useState([])

    // console.log('data dialogs', dialogs)

    useEffect(async () => {
        try {
            const data = await getAllDialogsApi()
            // console.log('data dialogs', data)
            setDialogs(data)
        } catch (err) {
            console.log('Error ', err)
        }
    }, [getAllDialogsApi])

    return (
        <div>
            {dialogs.length === 0 && <Loader/>}
            {dialogs && (
                dialogs.map((dialog, index) => (
                        <DialogUser key={index} dialog={dialog}/>
                    )
                ))
            }
        </div>
    )
}

const DialogUser = ({dialog}) => {
    return (
        <div className="card mb-3" style={{maxWidth: "540px"}}>
            <div className="row g-0">
                <div className="col-md-4">
                    <Link to={`/profile/${dialog.id}`}>
                        <img src={dialog.photos.large ? dialog.photos.large : userImgDefault} alt="..."
                             style={{width: '179px', height: '176px'}}/>
                    </Link>
                </div>
                <div className="col-md-8">
                    <div className="card-body">
                        <h5 className="card-title">{dialog.userName}</h5>
                        {dialog.hasNewMessages
                            ? <Link to={`/dialogs/${dialog.id}/messages`} className="btn btn-success">
                                You have new messages <span
                                className="badge bg-secondary">{dialog.newMessagesCount}</span>
                                <span className="visually-hidden">unread messages</span>
                            </Link>
                            : <Link to={`/dialogs/${dialog.id}/messages`} className="btn btn-secondary">
                                You have not new messages
                            </Link>
                        }
                        <br/>
                        <br/>
                        <small className="text-muted">User
                            was: {dialog.lastUserActivityDate.slice(0, 10)} {dialog.lastUserActivityDate.slice(11, 16)}</small>
                        <br/>
                        <small className="text-muted">Last
                            message: {dialog.lastDialogActivityDate.slice(0, 10)} {dialog.lastDialogActivityDate.slice(11, 16)}</small>
                    </div>
                </div>
            </div>
        </div>
    )
}

export default Dialogs